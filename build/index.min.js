$(function(){"use strict";function a(a){var b=new j.Parser;return b.makeHtml(a)}function b(a){var b,c,d,e;return b=new Date,c=Math.floor((b.getTime()-a)/864e5),c>0?c+" дн. назад":(d=Math.floor((b.getTime()-a)/36e5),d>0?d+" час. назад":(e=Math.floor((b.getTime()-a)/6e4),e>0?e+" мин. назад":"только что"))}var c={};c.VERSION="0.0.1";var d,e,f=[{id:"234",name:"Carabutur tristique",text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",score:3,time:"1407010357627"},{id:"2",parent:"234",name:"Carabutur tristique",text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",score:0,time:"1407010357627"},{id:"1",name:"Carabutur tristique",text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",score:-5,time:"1407010357627"},{id:"45",parent:"2",name:"Carabutur tristique",text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",score:0,time:"1407010357627"}],g=Backbone.Model.extend({defaults:{score:0,time:(new Date).getTime()}}),h=Backbone.Collection.extend({model:g}),i=Backbone.View.extend({tagName:"div",className:"comment-item",templates:{comment:_.template($("#comment-template").html()),hide:_.template($("#hide-template").html()),add:_.template($("#add-template").html()),show:_.template($("#show-template").html())},events:{"click .plus":"addScore","click .minus":"decScore","click .open-comment":"render","click .answer":"answer","click .button_blue":"save","click .hide-comment":"hide","click .show-comment":"show"},addScore:function(){this.$("#voting_"+this.model.attributes.id).html(this.model.attributes.score+=1),this.checkVoting()},decScore:function(){this.$("#voting_"+this.model.attributes.id).html(this.model.attributes.score-=1),this.checkVoting()},checkVoting:function(){this.model.attributes.score<-10&&$(this.el).html(this.templates.hide(this.model.toJSON()))},answer:function(){$(this.el).find(".comments-form").length<=0&&($(this.el).append(this.templates.add(this.model.toJSON())),H5F.setup(document.getElementById("add-comment")))},save:function(){var c=new g;if(!($(this.el).find(".error").length<=0&&$(this.el).find(".required").length<=0))return $(".comments-form").addClass("invalid"),$(this.el).find(".error-message").html("Не все поля заполнены<br/>"),$(this.el).find("input#name").hasClass("error")&&$(this.el).find(".error-message").append("Неверное имя<br/>"),void($(this.el).find("input#e-mail").hasClass("error")&&$(this.el).find(".error-message").append("Неверный E-mail<br/>"));c.set({id:this.model.attributes.id+100,parent:this.model.attributes.id,name:$(this.el).find("input#name").val(),text:a($(this.el).find("textarea").val()),time:b((new Date).getTime())});var d=new i({model:c});void 0!==c.attributes.parent?this.$("#comment_"+c.attributes.parent).after(d.render().el):this.el.append(d.render().el),$(this.el).find(".comments-form").remove()},hide:function(){$(this.el).append(this.templates.show(this.model.toJSON())),this.$("#comment_"+this.model.attributes.id).hide()},show:function(){e.renderComment(this.model),$(".show-comment").hide()},render:function(){return $(this.el).html(this.templates.comment(this.model.toJSON())),this}});d=Backbone.View.extend({el:$("#comments"),initialize:function(){this.collection=new h(f),this.render()},render:function(){var a=this;_.each(this.collection.models,function(b){a.renderComment(b)},this)},renderComment:function(a){a.attributes.time>0&&(a.attributes.time=b(a.attributes.time));var c=new i({model:a});void 0!==a.attributes.parent?this.$("#comment_"+a.attributes.parent).after(c.render().el):this.el.append(c.render().el)}}),e=new d;var j=j||{};return function(){j.Parser=function(){function a(a){return a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(a,b,c){var d=b.length;return"<h"+d+">"+c+"</h"+d+">\n"})}this.makeHtml=function(b){return b=new a(b)}}}(),c});